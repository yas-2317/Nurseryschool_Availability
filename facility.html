<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>園詳細</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>

<header class="page-header">
  <div class="container">
    <div class="header-top">
      <div class="titleblock">
        <h1 id="facName">園詳細</h1>
        <div class="sub">
          施設番号：<span id="facId">-</span>
          <span class="sep">/</span>
          最終更新：<span id="latestMonth">-</span>
        </div>
      </div>
      <div class="header-right">
        <a class="btn-link" href="index.html">← 一覧へ戻る</a>
      </div>
    </div>

    <!-- DBG (消してOK) -->
    <div id="dbgBox" class="small" style="margin-top:8px; padding:8px 10px; border:1px solid #e5e7eb; border-radius:12px; background:#fff;">
      DBG: <span id="dbg">loading...</span>
    </div>
  </div>
</header>

<main class="container">

  <!-- Summary (カード化) -->
  <div class="card facility-hero">
    <div class="hero-grid">
      <div class="hero-main">
        <div class="hero-lines">
          <div class="hero-line">
            <span class="label">住所</span>
            <span id="facAddr" class="value">—</span>
            <button id="copyAddr" class="btn-secondary btn-small" type="button">コピー</button>
          </div>

          <div class="hero-line">
            <span class="label">地図</span>
            <span id="facMap" class="value">—</span>
          </div>

          <div class="hero-line">
            <span class="label">最寄り</span>
            <span id="facStation" class="value">—</span>
            <span class="sep">/</span>
            <span id="facWalk" class="value">—</span>
            <a id="sameStationLink" class="btn-link" href="#" style="display:none;">同駅の園を見る</a>
          </div>
        </div>

        <div class="hero-metrics">
          <div class="metric">
            <div class="metric-title">最新：入所待ち（合計）</div>
            <div class="metric-value" id="latestWait">-</div>
            <div class="metric-sub">前月比 <span id="latestWaitDelta">—</span></div>
          </div>
          <div class="metric">
            <div class="metric-title">最新：受入可能（合計）</div>
            <div class="metric-value" id="latestAcc">-</div>
            <div class="metric-sub">前月比 <span id="latestAccDelta">—</span></div>
          </div>
        </div>

        <div class="chips" id="ageChips"></div>
      </div>

      <!-- Sparkline -->
      <div class="hero-side">
        <div class="small">推移（直近）</div>
        <div class="spark-block">
          <div class="spark-title">入所待ち（合計）</div>
          <div id="sparkWait"></div>
        </div>
        <div class="spark-block">
          <div class="spark-title">受入可能（合計）</div>
          <div id="sparkAcc"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Compact history -->
  <div class="card">
    <div class="section-head">
      <div>
        <div class="section-title">月次推移（コンパクト）</div>
        <div class="small">月 / 合計（待ち・受入） / 前月比（待ち・受入）</div>
      </div>
      <div class="section-actions">
        <label class="inline">
          <span class="small">表示件数</span>
          <select id="limitSel">
            <option value="12">直近12</option>
            <option value="24" selected>直近24</option>
            <option value="60">直近60</option>
            <option value="999">全部</option>
          </select>
        </label>
      </div>
    </div>

    <div class="tablewrap tablewrap-tall">
      <table id="hist">
        <thead>
          <tr>
            <th style="min-width:120px;">月</th>
            <th class="num" style="min-width:130px;">入所待ち（合計）</th>
            <th style="min-width:130px;">前月比</th>
            <th class="num" style="min-width:130px;">受入可能（合計）</th>
            <th style="min-width:130px;">前月比</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <details class="details">
      <summary>年齢別の推移を見る（0 / 1 / 2 / 3-5）</summary>
      <div class="tablewrap tablewrap-tall">
        <table id="histAge">
          <thead>
            <tr>
              <th style="min-width:120px;">月</th>
              <th class="num" style="min-width:90px;">0 受入</th><th class="num" style="min-width:90px;">0 待ち</th>
              <th class="num" style="min-width:90px;">1 受入</th><th class="num" style="min-width:90px;">1 待ち</th>
              <th class="num" style="min-width:90px;">2 受入</th><th class="num" style="min-width:90px;">2 待ち</th>
              <th class="num" style="min-width:110px;">3-5 受入</th><th class="num" style="min-width:110px;">3-5 待ち</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </details>
  </div>

</main>

<!-- ★ common.js は壊れてても続行したいので try で読む -->
<script>
(function(){
  const dbg = (msg)=>{ const el=document.getElementById('dbg'); if(el) el.textContent = msg; };

  // 先に最低限のfallbackを用意（common.js が落ちても動く）
  window.safeStr = window.safeStr || ((x)=> (x==null ? "" : String(x)));
  window.toIntOrNull = window.toIntOrNull || ((x)=>{
    if(x==null) return null;
    const s = String(x).trim();
    if(s==="" || s.toLowerCase()==="null" || s==="-") return null;
    const n = Number(s);
    if(!Number.isFinite(n)) return null;
    return Math.trunc(n);
  });
  window.fmt = window.fmt || ((x)=>{
    if(x==null) return "—";
    const s = String(x).trim();
    if(s==="" || s.toLowerCase()==="null" || s==="-") return "—";
    const n = Number(s);
    if(!Number.isFinite(n)) return "—";
    return n.toLocaleString("ja-JP");
  });
  window.fmtNum = window.fmtNum || window.fmt;

  window.getParam = window.getParam || ((key)=>{
    try{
      const u = new URL(window.location.href);
      return u.searchParams.get(key);
    }catch(e){
      const m = new RegExp("[?&]"+key+"=([^&]+)").exec(window.location.search);
      return m ? decodeURIComponent(m[1]) : null;
    }
  });

  window.loadJSON = window.loadJSON || (async (path)=>{
    const url = path + (path.includes("?") ? "&" : "?") + "v=" + Date.now();
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error(`Failed to load ${path} (${res.status})`);
    return await res.json();
  });

  window.toast = window.toast || ((msg)=>{
    const el = document.createElement("div");
    el.textContent = msg;
    el.style.position = "fixed";
    el.style.left = "50%";
    el.style.bottom = "18px";
    el.style.transform = "translateX(-50%)";
    el.style.padding = "10px 12px";
    el.style.borderRadius = "999px";
    el.style.background = "rgba(17,17,17,0.92)";
    el.style.color = "#fff";
    el.style.fontSize = "12px";
    el.style.zIndex = "9999";
    el.style.boxShadow = "0 6px 18px rgba(0,0,0,0.18)";
    document.body.appendChild(el);
    setTimeout(()=> el.remove(), 1200);
  });

  // common.js 読み込み（失敗しても致命傷にしない）
  try{
    const s = document.createElement("script");
    s.src = "common.js";
    s.async = false;
    s.onload = ()=> dbg("common.js loaded");
    s.onerror = ()=> dbg("common.js failed (fallback ok)");
    document.head.appendChild(s);
  }catch(e){
    dbg("common.js inject failed (fallback ok)");
  }
})();
</script>

<script>
function getGroups(f){
  if(f.age_groups) return f.age_groups;
  const ages = f.ages || f.ages_0_5 || {};
  function v(k, field){ return ages[k]?.[field]; }
  function sum3(field){
    const a = Number(v('3',field) ?? 0);
    const b = Number(v('4',field) ?? 0);
    const c = Number(v('5',field) ?? 0);
    const hasAny = (v('3',field)!=null) || (v('4',field)!=null) || (v('5',field)!=null);
    return hasAny ? (a+b+c) : null;
  }
  return {
    "0": {accept: v('0','accept'), wait: v('0','wait')},
    "1": {accept: v('1','accept'), wait: v('1','wait')},
    "2": {accept: v('2','accept'), wait: v('2','wait')},
    "3-5": {accept: sum3('accept'), wait: sum3('wait')}
  };
}

function signDelta(n){
  if(n==null) return `<span class="delta none">—</span>`;
  if(n>0) return `<span class="delta plus">+${n}</span>`;
  if(n<0) return `<span class="delta minus">${n}</span>`;
  return `<span class="delta zero">0</span>`;
}

function makeSparkline(values, {width=260, height=60}={}){
  const xs = values.map(v => (v==null ? null : Number(v)));
  const clean = xs.filter(v => v!=null && isFinite(v));
  if(clean.length < 2){
    return `<div class="small">—</div>`;
  }
  const min = Math.min(...clean);
  const max = Math.max(...clean);
  const pad = 6;
  const w = width, h = height;

  function y(v){
    if(max===min) return h/2;
    const t = (v - min) / (max - min);
    return (h - pad) - t*(h - pad*2);
  }
  function x(i){
    if(xs.length===1) return pad;
    return pad + i*(w - pad*2)/(xs.length-1);
  }

  let d = '';
  let started = false;
  xs.forEach((v,i)=>{
    if(v==null || !isFinite(v)) return;
    const px = x(i), py = y(v);
    if(!started){
      d += `M ${px} ${py}`;
      started = true;
    } else {
      d += ` L ${px} ${py}`;
    }
  });

  return `
  <svg class="spark" viewBox="0 0 ${w} ${h}" width="${w}" height="${h}" role="img" aria-label="sparkline">
    <path d="${d}" fill="none" stroke="currentColor" stroke-width="2" />
  </svg>`;
}

// ★施設の特定を「id一致」だけでなく「facility_id」「id」「文字列/数値差」「name一致」も拾う
function findFacility(obj, fid){
  const list = (obj && obj.facilities) ? obj.facilities : [];
  const sid = String(fid);
  // 1) id / facility_id
  let fac = list.find(x => String(x?.id) === sid) ||
            list.find(x => String(x?.facility_id) === sid);
  if(fac) return fac;
  return null;
}

async function main(){
  const dbg = (msg)=>{ const el=document.getElementById('dbg'); if(el) el.textContent = msg; };

  const fid = window.getParam('id');
  if(!fid){
    alert('id が指定されていません');
    location.href = 'index.html';
    return;
  }
  dbg(`id=${fid} / loading months.json...`);

  const monthsObj = await window.loadJSON('data/months.json');
  const months = (monthsObj.months||[]).slice().sort(); // asc
  dbg(`months=${months.length} / loading monthly files...`);

  const hist = [];
  let loaded = 0;
  let foundCount = 0;

  for(const m of months){
    try{
      const obj = await window.loadJSON(`data/${m}.json`);
      loaded++;
      const fac = findFacility(obj, fid);
      if(fac){
        foundCount++;
        hist.push({month:m, fac});
      }
    }catch(e){
      // ignore
    }
  }

  dbg(`loaded=${loaded}/${months.length}, found=${foundCount}`);

  if(hist.length===0){
    alert('該当施設が見つかりません（id不一致 or データ未反映）');
    location.href = 'index.html';
    return;
  }

  const latest = hist[hist.length-1];
  const prev = hist.length>=2 ? hist[hist.length-2] : null;

  const f = latest.fac;
  const pf = prev ? prev.fac : null;

  document.title = `${safeStr(f.name)}（園詳細）`;
  document.getElementById('facName').textContent = safeStr(f.name);
  document.getElementById('facId').textContent = safeStr(f.id ?? f.facility_id ?? fid);
  document.getElementById('latestMonth').textContent = latest.month;

  const addr = safeStr(f.address || '');
  document.getElementById('facAddr').textContent = addr || '—';

  const map = safeStr(f.map_url || '');
  document.getElementById('facMap').innerHTML = map ? `<a href="${map}" target="_blank" rel="noopener">Google Map を開く</a>` : '—';

  const st = safeStr(f.nearest_station || '');
  const wk = toIntOrNull(f.walk_minutes);
  document.getElementById('facStation').textContent = st || '—';
  document.getElementById('facWalk').textContent = (wk==null ? '—' : `徒歩 ${wk}分`);

  const stationQuery = (safeStr(f.station_kana).trim() || safeStr(f.nearest_station).replace(/駅$/,'').trim());
  if(stationQuery){
    const url = `index.html?q=${encodeURIComponent(stationQuery)}&view=basic&sort=station_walk_asc`;
    const a = document.getElementById('sameStationLink');
    a.href = url;
    a.style.display = '';
  }

  const copyBtn = document.getElementById('copyAddr');
  if(!addr) copyBtn.disabled = true;
  copyBtn.addEventListener('click', async ()=>{
    if(!addr) return;
    try{
      await navigator.clipboard.writeText(addr);
      toast('住所をコピーしました');
    }catch(e){
      alert('コピーに失敗しました');
    }
  });

  const wait = Number(f.totals?.wait ?? 0);
  const acc  = Number(f.totals?.accept ?? 0);
  const dWait = pf ? (Number(f.totals?.wait||0) - Number(pf.totals?.wait||0)) : null;
  const dAcc  = pf ? (Number(f.totals?.accept||0) - Number(pf.totals?.accept||0)) : null;

  document.getElementById('latestWait').textContent = fmtNum(wait);
  document.getElementById('latestAcc').textContent  = fmtNum(acc);
  document.getElementById('latestWaitDelta').innerHTML = signDelta(dWait);
  document.getElementById('latestAccDelta').innerHTML  = signDelta(dAcc);

  const g = getGroups(f);
  function chip(label, a, w){
    const aa = fmt(a);
    const ww = fmt(w);
    return `<div class="chip"><div class="chip-title">${label}</div><div class="chip-body">受入 ${aa} / 待ち ${ww}</div></div>`;
  }
  document.getElementById('ageChips').innerHTML = `
    ${chip('0歳', g?.['0']?.accept, g?.['0']?.wait)}
    ${chip('1歳', g?.['1']?.accept, g?.['1']?.wait)}
    ${chip('2歳', g?.['2']?.accept, g?.['2']?.wait)}
    ${chip('3〜5歳', g?.['3-5']?.accept, g?.['3-5']?.wait)}
  `;

  const lastN = hist.slice(Math.max(0, hist.length-24));
  const waitSeries = lastN.map(x => Number(x.fac.totals?.wait ?? 0));
  const accSeries  = lastN.map(x => Number(x.fac.totals?.accept ?? 0));
  document.getElementById('sparkWait').innerHTML = makeSparkline(waitSeries);
  document.getElementById('sparkAcc').innerHTML  = makeSparkline(accSeries);

  const limitSel = document.getElementById('limitSel');
  function renderTables(){
    const lim = Number(limitSel.value || 24);
    const slice = (lim>=999) ? hist : hist.slice(Math.max(0, hist.length - lim));

    const rows = [];
    for(let i=0;i<slice.length;i++){
      const cur = slice[i];
      const prevv = (i>0) ? slice[i-1] : null;
      const cw = Number(cur.fac.totals?.wait ?? 0);
      const ca = Number(cur.fac.totals?.accept ?? 0);
      const dw = prevv ? (cw - Number(prevv.fac.totals?.wait ?? 0)) : null;
      const da = prevv ? (ca - Number(prevv.fac.totals?.accept ?? 0)) : null;

      rows.push(`<tr>
        <td>${cur.month}</td>
        <td class="num">${fmtNum(cw)}</td>
        <td>${signDelta(dw)}</td>
        <td class="num">${fmtNum(ca)}</td>
        <td>${signDelta(da)}</td>
      </tr>`);
    }
    document.querySelector('#hist tbody').innerHTML = rows.reverse().join('');

    const rows2 = slice.map(cur=>{
      const gg = getGroups(cur.fac);
      function n(v){ return fmt(v); }
      return `<tr>
        <td>${cur.month}</td>
        <td class="num">${n(gg?.['0']?.accept)}</td><td class="num">${n(gg?.['0']?.wait)}</td>
        <td class="num">${n(gg?.['1']?.accept)}</td><td class="num">${n(gg?.['1']?.wait)}</td>
        <td class="num">${n(gg?.['2']?.accept)}</td><td class="num">${n(gg?.['2']?.wait)}</td>
        <td class="num">${n(gg?.['3-5']?.accept)}</td><td class="num">${n(gg?.['3-5']?.wait)}</td>
      </tr>`;
    });
    document.querySelector('#histAge tbody').innerHTML = rows2.reverse().join('');
  }

  limitSel.addEventListener('change', renderTables);
  renderTables();
}

main().catch(err=>{
  const el = document.getElementById('dbg');
  if(el) el.textContent = "ERROR: " + err.message;
  alert(err.message);
  console.error(err);
});
</script>
</body>
</html>
