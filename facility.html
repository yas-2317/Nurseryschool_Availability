<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>園詳細 | 横浜市 保育園 入所状況</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
<header>
  <div class="container">
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
      <a href="./index.html" style="font-weight:700;">← 一覧へ戻る</a>
      <span class="small" id="crumb">/ 園詳細</span>
    </div>

    <h1 id="facilityName" style="margin-top:10px;">-</h1>
    <div class="sub">
      データ時点：<span id="monthLabel">-</span>
      <span> / 施設番号：<span id="facilityId">-</span></span>
      <span> / 区：<span id="wardLabel">-</span></span>
    </div>

    <div class="controls" style="margin-top:12px;">
      <select id="monthSelect"></select>
      <button id="openMapBtn" type="button">Google Map を開く</button>
      <button id="copyAddrBtn" type="button">住所をコピー</button>
      <span class="badge">※「入所待ち人数」は園ごとの申込件数（重複計上あり）</span>
    </div>
  </div>
</header>

<main class="container">

  <!-- 基本情報 -->
  <div class="card">
    <div class="kpi" id="kpiTop"></div>

    <div style="margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px;" class="infoGrid">
      <div class="infoItem">
        <div class="small">住所</div>
        <div id="addr">—</div>
      </div>
      <div class="infoItem">
        <div class="small">最寄り駅 / 徒歩</div>
        <div id="stationWalk">—</div>
      </div>
      <div class="infoItem">
        <div class="small">電話</div>
        <div id="phone">—</div>
      </div>
      <div class="infoItem">
        <div class="small">Web</div>
        <div id="website">—</div>
      </div>
    </div>

    <div class="small" style="margin-top:10px;">
      表示されない項目は <code>data/master_facilities.csv</code> に値が無い（月次JSONに反映されていない）可能性があります。
    </div>
  </div>

  <!-- 月次サマリ -->
  <div class="card">
    <h2 style="margin:0 0 10px 0;font-size:16px;">今月サマリ</h2>
    <div id="summary" class="small">—</div>
  </div>

  <!-- 年齢別（4区分） -->
  <div class="card tablewrap">
    <table id="hist">
      <thead>
        <tr>
          <th style="min-width:140px;">区分</th>
          <th style="min-width:120px;">受入可能</th>
          <th style="min-width:120px;">入所待ち</th>
          <th style="min-width:140px;">前月比（待ち）</th>
          <th style="min-width:140px;">前月比（受入）</th>
        </tr>
      </thead>
      <tbody id="ageTbody"></tbody>
    </table>
  </div>

  <!-- 参考：0-5歳（ある月だけ） -->
  <div class="card tablewrap">
    <h2 style="margin:0 0 10px 0;font-size:16px;">参考：0〜5歳（データがある場合のみ）</h2>
    <table id="ages05">
      <thead>
        <tr>
          <th style="min-width:80px;">年齢</th>
          <th style="min-width:120px;">受入可能</th>
          <th style="min-width:120px;">入所待ち</th>
        </tr>
      </thead>
      <tbody id="ages05Body"></tbody>
    </table>
    <div class="small" style="margin-top:8px;">
      ※月によって 0〜5 の列が無い場合があります。その場合は表示されません。
    </div>
  </div>

  <div class="footer">
    出典：横浜市「保育所等の入所状況（毎月1日時点）」の公開データを加工（本サイトは非公式）。
  </div>
</main>

<script src="common.js"></script>
<script>
/** ===== facility detail ===== */
function groupLabel(key){
  if(key==="0") return "0歳";
  if(key==="1") return "1歳";
  if(key==="2") return "2歳";
  if(key==="3-5") return "3〜5歳";
  return key;
}

function getGroups(f){
  if(f && f.age_groups) return f.age_groups;

  // 旧スキーマ互換（ages_0_5 から 3-5 合算）
  const ages = (f && (f.ages_0_5 || f.ages || {})) || {};
  function v(k, field){ return ages[k]?.[field]; }
  function sum3(field){
    const a = Number(v('3',field) ?? 0);
    const b = Number(v('4',field) ?? 0);
    const c = Number(v('5',field) ?? 0);
    const hasAny = (v('3',field)!=null) || (v('4',field)!=null) || (v('5',field)!=null);
    return hasAny ? (a+b+c) : null;
  }
  return {
    "0": {accept: v('0','accept'), wait: v('0','wait')},
    "1": {accept: v('1','accept'), wait: v('1','wait')},
    "2": {accept: v('2','accept'), wait: v('2','wait')},
    "3-5": {accept: sum3('accept'), wait: sum3('wait')},
  };
}

function deltaSpan(n){
  if(n==null) return `<span class="delta none">—</span>`;
  if(n>0) return `<span class="delta plus">+${n}</span>`;
  if(n<0) return `<span class="delta minus">${n}</span>`;
  return `<span class="delta zero">0</span>`;
}

function setText(id, txt){
  const el = document.getElementById(id);
  if(el) el.textContent = (txt==null||txt==="") ? "—" : String(txt);
}

function setHTML(id, html){
  const el = document.getElementById(id);
  if(el) el.innerHTML = html;
}

async function main(){
  const id = getParam("id");
  if(!id) throw new Error("URL に id がありません（facility.html?id=...）");

  const monthsObj = await loadJSON("data/months.json");
  const ms = (monthsObj.months||[]).slice().sort();
  const sel = document.getElementById("monthSelect");
  sel.innerHTML = ms.map(m=>`<option value="${m}">${m}</option>`).join("");
  sel.value = ms.length ? ms[ms.length-1] : "";

  async function render(){
    const month = sel.value;
    const idx = ms.indexOf(month);
    const prevMonth = (idx>0) ? ms[idx-1] : null;

    const data = await loadJSON(`data/${month}.json`);
    const prevData = prevMonth ? await loadJSON(`data/${prevMonth}.json`) : null;

    const f = (data.facilities||[]).find(x => String(x.id) === String(id));
    if(!f) throw new Error(`この月に施設が見つかりません: id=${id} / month=${month}`);

    const prevF = prevData ? (prevData.facilities||[]).find(x => String(x.id)===String(id)) : null;

    document.title = `${safeStr(f.name)} | 園詳細`;
    setText("facilityName", safeStr(f.name));
    setText("monthLabel", prevMonth ? `${month}（前月：${prevMonth}）` : month);
    setText("facilityId", safeStr(f.id));
    setText("wardLabel", safeStr(f.ward||data.ward||""));

    // 基本情報
    setText("addr", safeStr(f.address));
    const st = safeStr(f.nearest_station);
    const wk = toIntOrNull(f.walk_minutes);
    setText("stationWalk", (st||wk!=null) ? `${st||"—"} / ${wk!=null ? wk+"分" : "—"}` : "—");
    setText("phone", safeStr(f.phone));
    const web = safeStr(f.website);
    setHTML("website", web ? `<a href="${web}" target="_blank" rel="noopener">${web}</a>` : "—");

    // map button
    const map = safeStr(f.map_url);
    const openMapBtn = document.getElementById("openMapBtn");
    openMapBtn.disabled = !map;
    openMapBtn.onclick = ()=>{ if(map) window.open(map, "_blank", "noopener"); };

    // copy addr
    const copyAddrBtn = document.getElementById("copyAddrBtn");
    copyAddrBtn.onclick = async ()=>{
      const a = safeStr(f.address);
      if(!a) return;
      try{
        await navigator.clipboard.writeText(a);
        copyAddrBtn.textContent = "コピーしました";
        setTimeout(()=>copyAddrBtn.textContent="住所をコピー", 1200);
      }catch(e){
        alert("コピーできませんでした（ブラウザ制限の可能性）");
      }
    };

    // KPI（合計 + 前月比）
    const totWait = toIntOrNull(f.totals?.wait) ?? 0;
    const totAcc  = toIntOrNull(f.totals?.accept) ?? 0;
    const dW = prevF ? (totWait - (toIntOrNull(prevF.totals?.wait) ?? 0)) : null;
    const dA = prevF ? (totAcc  - (toIntOrNull(prevF.totals?.accept) ?? 0)) : null;

    setHTML("kpiTop", `
      <div class="pill">合計 入所待ち：${fmt(totWait)}（前月比 ${deltaSpan(dW)}）</div>
      <div class="pill">合計 受入可能：${fmt(totAcc)}（前月比 ${deltaSpan(dA)}）</div>
      <div class="pill">駅×徒歩：${st ? safeStr(st) : "—"} ${wk!=null ? `(${wk}分)` : ""}</div>
    `);

    setHTML("summary", `
      <div>合計：受入可能 <b>${fmt(totAcc)}</b> / 入所待ち <b>${fmt(totWait)}</b></div>
      <div>前月比：受入可能 ${deltaSpan(dA)} / 入所待ち ${deltaSpan(dW)}</div>
    `);

    // 年齢別4区分テーブル
    const g = getGroups(f);
    const gp = prevF ? getGroups(prevF) : null;

    const keys = ["0","1","2","3-5"];
    const rows = keys.map(k=>{
      const acc = toIntOrNull(g?.[k]?.accept);
      const wai = toIntOrNull(g?.[k]?.wait);
      const pAcc = gp ? toIntOrNull(gp?.[k]?.accept) : null;
      const pWai = gp ? toIntOrNull(gp?.[k]?.wait) : null;
      const dAcc = (pAcc==null) ? null : ((acc??0) - pAcc);
      const dWai = (pWai==null) ? null : ((wai??0) - pWai);

      return `
        <tr>
          <td><b>${groupLabel(k)}</b></td>
          <td>${fmt(acc)}</td>
          <td>${fmt(wai)}</td>
          <td>${deltaSpan(dWai)}</td>
          <td>${deltaSpan(dAcc)}</td>
        </tr>
      `;
    }).join("");

    document.getElementById("ageTbody").innerHTML = rows;

    // 0-5歳（ある場合のみ）
    const a05 = f.ages_0_5 || f.ages || null;
    const body = document.getElementById("ages05Body");
    if(a05 && typeof a05 === "object"){
      const rr = ["0","1","2","3","4","5"].map(k=>{
        const acc = toIntOrNull(a05?.[k]?.accept);
        const wai = toIntOrNull(a05?.[k]?.wait);
        if(acc==null && wai==null) return "";
        return `
          <tr>
            <td>${k}歳</td>
            <td>${fmt(acc)}</td>
            <td>${fmt(wai)}</td>
          </tr>
        `;
      }).join("");
      body.innerHTML = rr || `<tr><td colspan="3" class="small">この月は 0〜5 の内訳データがありません</td></tr>`;
    }else{
      body.innerHTML = `<tr><td colspan="3" class="small">この月は 0〜5 の内訳データがありません</td></tr>`;
    }
  }

  sel.addEventListener("change", render);
  await render();
}

main().catch(err=>{
  console.error(err);
  alert(err.message || String(err));
});
</script>

<style>
/* facility page small enhancements (keeps your styles.css as source of truth) */
.infoGrid{
  align-items: start;
}
.infoItem{
  background: rgba(255,255,255,0.6);
  border: 1px solid var(--border, #e5e7eb);
  border-radius: 12px;
  padding: 10px 12px;
}
@media (max-width: 768px){
  .infoGrid{ grid-template-columns: 1fr !important; }
}
</style>
</body>
</html>
